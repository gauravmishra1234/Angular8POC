import * as tslib_1 from "tslib";
import { Directive, ElementRef, Input, Output, EventEmitter, Renderer2, } from '@angular/core';
import { Subject, zip, fromEvent } from 'rxjs';
import { tap, map, pairwise, takeWhile, skipWhile, debounceTime } from 'rxjs/operators';
import { DirectiveStateService } from './directive-state.service';
import { InitialScrollPosition } from './enum/initial-scroll-position-type.enum';
import { DirectiveContext } from './directive-context';
import { ScrollingToTop } from './scrolling-strategy/scrolling-to-top';
import { ScrollingToBottom } from './scrolling-strategy/scrolling-to-bottom';
import { ScrollingToBoth } from './scrolling-strategy/scrolling-to-both';
import { ScrollHeightListener } from './scroll-height-listener/scroll-height-listener';
var NgxInfiniteScrollerDirective = /** @class */ (function (_super) {
    tslib_1.__extends(NgxInfiniteScrollerDirective, _super);
    function NgxInfiniteScrollerDirective(el, renderer, state) {
        var _this = _super.call(this) || this;
        _this.el = el;
        _this.renderer = renderer;
        _this.state = state;
        _this.strategy = 'scrollingToBottom';
        _this.initialScrollPosition = InitialScrollPosition.DEFAULT;
        _this.scrollbarAnimationInterval = 100;
        _this.scrollDebounceTimeAfterScrollHeightChanged = 50;
        _this.scrollDebounceTimeAfterDOMMutationOnInit = 1000;
        _this.scrollUpPercentilePositionTrigger = 2;
        _this.scrollDownPercentilePositionTrigger = 98;
        _this.onScrollUp = new EventEmitter();
        _this.onScrollDown = new EventEmitter();
        _this.scrollHeightChanged = new Subject();
        _this.domMutationEmitter = new Subject();
        _this.state.setup({
            el: el,
            initMode: true,
            scrollStreamActive: true,
            previousScrollPositionpUpdated: false
        });
        return _this;
    }
    Object.defineProperty(NgxInfiniteScrollerDirective.prototype, "scrollPairChanged", {
        get: function () {
            var _this = this;
            if (this.scrollChanged) {
                return this.scrollChanged.pipe(takeWhile(function () { return _this.state.scrollStreamActive; }), map(function (e) {
                    return {
                        scrollHeight: e.target.scrollHeight,
                        scrollTop: e.target.scrollTop,
                        clientHeight: e.target.clientHeight,
                    };
                }), pairwise(), debounceTime(this.scrollbarAnimationInterval));
            }
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(NgxInfiniteScrollerDirective.prototype, "scrollDirectionChanged", {
        get: function () {
            return this.scrollingStrategy.scrollDirectionChanged(this.scrollPairChanged);
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(NgxInfiniteScrollerDirective.prototype, "scrollRequestZoneChanged", {
        get: function () {
            var _this = this;
            return this.scrollingStrategy.scrollRequestZoneChanged(this.scrollDirectionChanged).pipe(tap(function () {
                _this.state.updatePreviousScrollTop();
                _this.state.updatePreviousScrollHeight();
                _this.state.previousScrollPositionpUpdated = false;
                _this.scrollHeightListener.start();
            }));
        },
        enumerable: true,
        configurable: true
    });
    NgxInfiniteScrollerDirective.prototype.ngOnInit = function () {
        this.useStrategy();
        this.useScrollHeightListener();
        this.registerScrollEventHandler();
        this.registerMutationObserver();
        this.registerInitialScrollPostionHandler();
        this.registerPreviousScrollPositionHandler();
    };
    NgxInfiniteScrollerDirective.prototype.ngAfterViewInit = function () {
        this.registerScrollSpy();
    };
    NgxInfiniteScrollerDirective.prototype.ngOnDestroy = function () {
        this.domMutationObserver.disconnect();
    };
    NgxInfiniteScrollerDirective.prototype.scrollTo = function (position) {
        this.state.scrollStreamActive = false;
        this.renderer.setProperty(this.el.nativeElement, 'scrollTop', position);
        this.state.scrollStreamActive = true;
    };
    NgxInfiniteScrollerDirective.prototype.onScrollbarHeightChanged = function () {
        this.scrollHeightChanged.next();
    };
    NgxInfiniteScrollerDirective.prototype.registerScrollEventHandler = function () {
        this.scrollChanged = fromEvent(this.el.nativeElement, 'scroll');
    };
    NgxInfiniteScrollerDirective.prototype.registerMutationObserver = function () {
        var _this = this;
        this.domMutationObserver = new MutationObserver(function (mutations) {
            _this.domMutationEmitter.next(mutations);
        });
        var config = { attributes: true, childList: true, characterData: true };
        this.domMutationObserver.observe(this.el.nativeElement, config);
    };
    NgxInfiniteScrollerDirective.prototype.registerInitialScrollPostionHandler = function () {
        var _this = this;
        this.domMutationEmitter.pipe(takeWhile(function () { return _this.state.initMode; }), debounceTime(this.scrollDebounceTimeAfterDOMMutationOnInit)).subscribe(function () {
            _this.scrollingStrategy.setInitialScrollPosition();
            _this.state.initMode = false;
        });
    };
    NgxInfiniteScrollerDirective.prototype.registerPreviousScrollPositionHandler = function () {
        var _this = this;
        zip(this.scrollRequestZoneChanged, this.scrollHeightChanged).pipe(skipWhile(function () { return _this.state.initMode; }), debounceTime(this.scrollDebounceTimeAfterScrollHeightChanged)).subscribe(function () {
            _this.scrollingStrategy.setPreviousScrollPosition();
            _this.state.previousScrollPositionpUpdated = true;
        });
    };
    NgxInfiniteScrollerDirective.prototype.registerScrollSpy = function () {
        var _this = this;
        this.scrollRequestZoneChanged.subscribe(function () {
            _this.scrollingStrategy.askForUpdate();
        });
    };
    NgxInfiniteScrollerDirective.prototype.useStrategy = function () {
        switch (this.strategy) {
            case 'scrollingToBoth':
                this.scrollingStrategy = new ScrollingToBoth(this, this.state);
                break;
            case 'scrollingToTop':
                this.scrollingStrategy = new ScrollingToTop(this, this.state);
                break;
            case 'scrollingToBottom':
            default:
                this.scrollingStrategy = new ScrollingToBottom(this, this.state);
                break;
        }
    };
    NgxInfiniteScrollerDirective.prototype.useScrollHeightListener = function () {
        this.scrollHeightListener = new ScrollHeightListener(this, this.state);
    };
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", String)
    ], NgxInfiniteScrollerDirective.prototype, "strategy", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Object)
    ], NgxInfiniteScrollerDirective.prototype, "initialScrollPosition", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Object)
    ], NgxInfiniteScrollerDirective.prototype, "scrollbarAnimationInterval", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Object)
    ], NgxInfiniteScrollerDirective.prototype, "scrollDebounceTimeAfterScrollHeightChanged", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Object)
    ], NgxInfiniteScrollerDirective.prototype, "scrollDebounceTimeAfterDOMMutationOnInit", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Object)
    ], NgxInfiniteScrollerDirective.prototype, "scrollUpPercentilePositionTrigger", void 0);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Object)
    ], NgxInfiniteScrollerDirective.prototype, "scrollDownPercentilePositionTrigger", void 0);
    tslib_1.__decorate([
        Output(),
        tslib_1.__metadata("design:type", EventEmitter)
    ], NgxInfiniteScrollerDirective.prototype, "onScrollUp", void 0);
    tslib_1.__decorate([
        Output(),
        tslib_1.__metadata("design:type", EventEmitter)
    ], NgxInfiniteScrollerDirective.prototype, "onScrollDown", void 0);
    NgxInfiniteScrollerDirective = tslib_1.__decorate([
        Directive({
            selector: '[ngxInfiniteScroller]'
        }),
        tslib_1.__metadata("design:paramtypes", [ElementRef,
            Renderer2,
            DirectiveStateService])
    ], NgxInfiniteScrollerDirective);
    return NgxInfiniteScrollerDirective;
}(DirectiveContext));
export { NgxInfiniteScrollerDirective };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LWluZmluaXRlLXNjcm9sbGVyLmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25neC1pbmZpbml0ZS1zY3JvbGxlci8iLCJzb3VyY2VzIjpbInNyYy9hcHAvbmd4LWluZmluaXRlLXNjcm9sbGVyLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUNMLFNBQVMsRUFJVCxVQUFVLEVBQ1YsS0FBSyxFQUNMLE1BQU0sRUFDTixZQUFZLEVBQ1osU0FBUyxHQUNWLE1BQU0sZUFBZSxDQUFDO0FBRXZCLE9BQU8sRUFBYyxPQUFPLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUUzRCxPQUFPLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxRQUFRLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxZQUFZLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUV4RixPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUdsRSxPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSwwQ0FBMEMsQ0FBQztBQUVqRixPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUN2RCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sdUNBQXVDLENBQUM7QUFDdkUsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sMENBQTBDLENBQUM7QUFDN0UsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHdDQUF3QyxDQUFDO0FBRXpFLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLGlEQUFpRCxDQUFDO0FBS3ZGO0lBQ1Usd0RBQWdCO0lBd0V4QixzQ0FDVSxFQUFjLEVBQ2QsUUFBbUIsRUFDbkIsS0FBNEI7UUFIdEMsWUFLRSxpQkFBTyxTQU9SO1FBWFMsUUFBRSxHQUFGLEVBQUUsQ0FBWTtRQUNkLGNBQVEsR0FBUixRQUFRLENBQVc7UUFDbkIsV0FBSyxHQUFMLEtBQUssQ0FBdUI7UUF2RS9C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QixDQUFDO1lBQUM7Z0JBQ3hCLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxJQUFJLGlCQUFpQixDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7Z0JBQ2pFLE1BQU07U0FDVDtJQUNILENBQUM7SUFFTyw4REFBdUIsR0FBL0I7UUFDRSxJQUFJLENBQUMsb0JBQW9CLEdBQUcsSUFBSSxvQkFBb0IsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ3pFLENBQUM7SUF6S0Q7UUFEQyxLQUFLLEVBQUU7O2tFQUNzQztJQUc5QztRQURDLEtBQUssRUFBRTs7K0VBQ3FGO0lBRzdGO1FBREMsS0FBSyxFQUFFOztvRkFDZ0M7SUFHeEM7UUFEQyxLQUFLLEVBQUU7O29HQUMrQztJQUd2RDtRQURDLEtBQUssRUFBRTs7a0dBQytDO0lBR3ZEO1FBREMsS0FBSyxFQUFFOzsyRkFDcUM7SUFHN0M7UUFEQyxLQUFLLEVBQUU7OzZGQUN3QztJQUdoRDtRQURDLE1BQU0sRUFBRTswQ0FDVSxZQUFZO29FQUFrQztJQUdqRTtRQURDLE1BQU0sRUFBRTswQ0FDWSxZQUFZO3NFQUFrQztJQTdCeEQsNEJBQTRCO1FBSHhDLFNBQVMsQ0FBQztZQUNULFFBQVEsRUFBRSx1QkFBdUI7U0FDbEMsQ0FBQztpREEyRWMsVUFBVTtZQUNKLFNBQVM7WUFDWixxQkFBcUI7T0E1RTNCLDRCQUE0QixDQStLeEM7SUFBRCxtQ0FBQztDQUFBLEFBL0tELENBQ1UsZ0JBQWdCLEdBOEt6QjtTQS9LWSw0QkFBNEIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xyXG4gIERpcmVjdGl2ZSxcclxuICBPbkRlc3Ryb3ksXHJcbiAgT25Jbml0LFxyXG4gIEFmdGVyVmlld0luaXQsXHJcbiAgRWxlbWVudFJlZixcclxuICBJbnB1dCxcclxuICBPdXRwdXQsXHJcbiAgRXZlbnRFbWl0dGVyLFxyXG4gIFJlbmRlcmVyMixcclxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuXHJcbmltcG9ydCB7IE9ic2VydmFibGUsIFN1YmplY3QsIHppcCwgZnJvbUV2ZW50IH0gZnJvbSAncnhqcyc7XHJcblxyXG5pbXBvcnQgeyB0YXAsIG1hcCwgcGFpcndpc2UsIHRha2VXaGlsZSwgc2tpcFdoaWxlLCBkZWJvdW5jZVRpbWUgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcblxyXG5pbXBvcnQgeyBEaXJlY3RpdmVTdGF0ZVNlcnZpY2UgfSBmcm9tICcuL2RpcmVjdGl2ZS1zdGF0ZS5zZXJ2aWNlJztcclxuXHJcbmltcG9ydCB7IFNjcm9sbFBvc2l0aW9uIH0gZnJvbSAnLi9tb2RlbC9zY3JvbGwtcG9zaXRpb24ubW9kZWwnO1xyXG5pbXBvcnQgeyBJbml0aWFsU2Nyb2xsUG9zaXRpb24gfSBmcm9tICcuL2VudW0vaW5pdGlhbC1zY3JvbGwtcG9zaXRpb24tdHlwZS5lbnVtJztcclxuXHJcbmltcG9ydCB7IERpcmVjdGl2ZUNvbnRleHQgfSBmcm9tICcuL2RpcmVjdGl2ZS1jb250ZXh0JztcclxuaW1wb3J0IHsgU2Nyb2xsaW5nVG9Ub3AgfSBmcm9tICcuL3Njcm9sbGluZy1zdHJhdGVneS9zY3JvbGxpbmctdG8tdG9wJztcclxuaW1wb3J0IHsgU2Nyb2xsaW5nVG9Cb3R0b20gfSBmcm9tICcuL3Njcm9sbGluZy1zdHJhdGVneS9zY3JvbGxpbmctdG8tYm90dG9tJztcclxuaW1wb3J0IHsgU2Nyb2xsaW5nVG9Cb3RoIH0gZnJvbSAnLi9zY3JvbGxpbmctc3RyYXRlZ3kvc2Nyb2xsaW5nLXRvLWJvdGgnO1xyXG5cclxuaW1wb3J0IHsgU2Nyb2xsSGVpZ2h0TGlzdGVuZXIgfSBmcm9tICcuL3Njcm9sbC1oZWlnaHQtbGlzdGVuZXIvc2Nyb2xsLWhlaWdodC1saXN0ZW5lcic7XHJcblxyXG5ARGlyZWN0aXZlKHtcclxuICBzZWxlY3RvcjogJ1tuZ3hJbmZpbml0ZVNjcm9sbGVyXSdcclxufSlcclxuZXhwb3J0IGNsYXNzIE5neEluZmluaXRlU2Nyb2xsZXJEaXJlY3RpdmVcclxuICBleHRlbmRzIERpcmVjdGl2ZUNvbnRleHRcclxuICBpbXBsZW1lbnRzIE9uSW5pdCwgQWZ0ZXJWaWV3SW5pdCwgT25EZXN0cm95IHtcclxuXHJcbiAgQElucHV0KClcclxuICBwdWJsaWMgc3RyYXRlZ3k6IHN0cmluZyA9ICdzY3JvbGxpbmdUb0JvdHRvbSc7XHJcblxyXG4gIEBJbnB1dCgpXHJcbiAgcHVibGljIGluaXRpYWxTY3JvbGxQb3NpdGlvbjogSW5pdGlhbFNjcm9sbFBvc2l0aW9uIHwgbnVtYmVyID0gSW5pdGlhbFNjcm9sbFBvc2l0aW9uLkRFRkFVTFQ7XHJcblxyXG4gIEBJbnB1dCgpXHJcbiAgcHVibGljIHNjcm9sbGJhckFuaW1hdGlvbkludGVydmFsID0gMTAwO1xyXG5cclxuICBASW5wdXQoKVxyXG4gIHB1YmxpYyBzY3JvbGxEZWJvdW5jZVRpbWVBZnRlclNjcm9sbEhlaWdodENoYW5nZWQgPSA1MDtcclxuXHJcbiAgQElucHV0KClcclxuICBwdWJsaWMgc2Nyb2xsRGVib3VuY2VUaW1lQWZ0ZXJET01NdXRhdGlvbk9uSW5pdCA9IDEwMDA7XHJcblxyXG4gIEBJbnB1dCgpXHJcbiAgcHVibGljIHNjcm9sbFVwUGVyY2VudGlsZVBvc2l0aW9uVHJpZ2dlciA9IDI7XHJcblxyXG4gIEBJbnB1dCgpXHJcbiAgcHVibGljIHNjcm9sbERvd25QZXJjZW50aWxlUG9zaXRpb25UcmlnZ2VyID0gOTg7XHJcblxyXG4gIEBPdXRwdXQoKVxyXG4gIHB1YmxpYyBvblNjcm9sbFVwOiBFdmVudEVtaXR0ZXI8bnVsbD4gPSBuZXcgRXZlbnRFbWl0dGVyPG51bGw+KCk7XHJcblxyXG4gIEBPdXRwdXQoKVxyXG4gIHB1YmxpYyBvblNjcm9sbERvd246IEV2ZW50RW1pdHRlcjxudWxsPiA9IG5ldyBFdmVudEVtaXR0ZXI8bnVsbD4oKTtcclxuXHJcbiAgcHJpdmF0ZSBzY3JvbGxIZWlnaHRMaXN0ZW5lcjogU2Nyb2xsSGVpZ2h0TGlzdGVuZXI7XHJcblxyXG4gIHByaXZhdGUgc2Nyb2xsSGVpZ2h0Q2hhbmdlZDogU3ViamVjdDxudWxsPiA9IG5ldyBTdWJqZWN0PG51bGw+KCk7XHJcblxyXG4gIHByaXZhdGUgZG9tTXV0YXRpb25PYnNlcnZlcjogTXV0YXRpb25PYnNlcnZlcjtcclxuXHJcbiAgcHJpdmF0ZSBkb21NdXRhdGlvbkVtaXR0ZXI6IFN1YmplY3Q8TXV0YXRpb25SZWNvcmRbXT4gPSBuZXcgU3ViamVjdDxNdXRhdGlvblJlY29yZFtdPigpO1xyXG5cclxuICBwcml2YXRlIHNjcm9sbENoYW5nZWQ6IE9ic2VydmFibGU8RXZlbnQ+O1xyXG5cclxuICBwcml2YXRlIGdldCBzY3JvbGxQYWlyQ2hhbmdlZCgpOiBPYnNlcnZhYmxlPFNjcm9sbFBvc2l0aW9uW10+IHtcclxuICAgIGlmICh0aGlzLnNjcm9sbENoYW5nZWQpIHtcclxuICAgICAgcmV0dXJuIHRoaXMuc2Nyb2xsQ2hhbmdlZC5waXBlKFxyXG4gICAgICAgIHRha2VXaGlsZSgoKSA9PiB0aGlzLnN0YXRlLnNjcm9sbFN0cmVhbUFjdGl2ZSksXHJcbiAgICAgICAgbWFwKChlOiBhbnkpID0+IHtcclxuICAgICAgICAgIHJldHVybiA8U2Nyb2xsUG9zaXRpb24+e1xyXG4gICAgICAgICAgICBzY3JvbGxIZWlnaHQ6IGUudGFyZ2V0LnNjcm9sbEhlaWdodCxcclxuICAgICAgICAgICAgc2Nyb2xsVG9wOiBlLnRhcmdldC5zY3JvbGxUb3AsXHJcbiAgICAgICAgICAgIGNsaWVudEhlaWdodDogZS50YXJnZXQuY2xpZW50SGVpZ2h0LFxyXG4gICAgICAgICAgfTtcclxuICAgICAgICB9KSxcclxuICAgICAgICBwYWlyd2lzZSgpLFxyXG4gICAgICAgIGRlYm91bmNlVGltZSh0aGlzLnNjcm9sbGJhckFuaW1hdGlvbkludGVydmFsKVxyXG4gICAgICApO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBnZXQgc2Nyb2xsRGlyZWN0aW9uQ2hhbmdlZCgpOiBPYnNlcnZhYmxlPFNjcm9sbFBvc2l0aW9uW10+IHtcclxuICAgIHJldHVybiB0aGlzLnNjcm9sbGluZ1N0cmF0ZWd5LnNjcm9sbERpcmVjdGlvbkNoYW5nZWQodGhpcy5zY3JvbGxQYWlyQ2hhbmdlZCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGdldCBzY3JvbGxSZXF1ZXN0Wm9uZUNoYW5nZWQoKTogT2JzZXJ2YWJsZTxTY3JvbGxQb3NpdGlvbltdPiB7XHJcbiAgICByZXR1cm4gdGhpcy5zY3JvbGxpbmdTdHJhdGVneS5zY3JvbGxSZXF1ZXN0Wm9uZUNoYW5nZWQodGhpcy5zY3JvbGxEaXJlY3Rpb25DaGFuZ2VkKS5waXBlKFxyXG4gICAgICB0YXAoKCkgPT4ge1xyXG4gICAgICAgIHRoaXMuc3RhdGUudXBkYXRlUHJldmlvdXNTY3JvbGxUb3AoKTtcclxuICAgICAgICB0aGlzLnN0YXRlLnVwZGF0ZVByZXZpb3VzU2Nyb2xsSGVpZ2h0KCk7XHJcbiAgICAgICAgdGhpcy5zdGF0ZS5wcmV2aW91c1Njcm9sbFBvc2l0aW9ucFVwZGF0ZWQgPSBmYWxzZTtcclxuICAgICAgICB0aGlzLnNjcm9sbEhlaWdodExpc3RlbmVyLnN0YXJ0KCk7XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBwcml2YXRlIGVsOiBFbGVtZW50UmVmLFxyXG4gICAgcHJpdmF0ZSByZW5kZXJlcjogUmVuZGVyZXIyLFxyXG4gICAgcHJpdmF0ZSBzdGF0ZTogRGlyZWN0aXZlU3RhdGVTZXJ2aWNlXHJcbiAgKSB7XHJcbiAgICBzdXBlcigpO1xyXG4gICAgdGhpcy5zdGF0ZS5zZXR1cCh7XHJcbiAgICAgIGVsOiBlbCxcclxuICAgICAgaW5pdE1vZGU6IHRydWUsXHJcbiAgICAgIHNjcm9sbFN0cmVhbUFjdGl2ZTogdHJ1ZSxcclxuICAgICAgcHJldmlvdXNTY3JvbGxQb3NpdGlvbnBVcGRhdGVkOiBmYWxzZVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgbmdPbkluaXQoKTogdm9pZCB7XHJcbiAgICB0aGlzLnVzZVN0cmF0ZWd5KCk7XHJcbiAgICB0aGlzLnVzZVNjcm9sbEhlaWdodExpc3RlbmVyKCk7XHJcblxyXG4gICAgdGhpcy5yZWdpc3RlclNjcm9sbEV2ZW50SGFuZGxlcigpO1xyXG4gICAgdGhpcy5yZWdpc3Rlck11dGF0aW9uT2JzZXJ2ZXIoKTtcclxuICAgIHRoaXMucmVnaXN0ZXJJbml0aWFsU2Nyb2xsUG9zdGlvbkhhbmRsZXIoKTtcclxuICAgIHRoaXMucmVnaXN0ZXJQcmV2aW91c1Njcm9sbFBvc2l0aW9uSGFuZGxlcigpO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIG5nQWZ0ZXJWaWV3SW5pdCgpOiB2b2lkIHtcclxuICAgIHRoaXMucmVnaXN0ZXJTY3JvbGxTcHkoKTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBuZ09uRGVzdHJveSgpOiB2b2lkIHtcclxuICAgIHRoaXMuZG9tTXV0YXRpb25PYnNlcnZlci5kaXNjb25uZWN0KCk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgc2Nyb2xsVG8ocG9zaXRpb246IG51bWJlcik6IHZvaWQge1xyXG4gICAgdGhpcy5zdGF0ZS5zY3JvbGxTdHJlYW1BY3RpdmUgPSBmYWxzZTtcclxuICAgIHRoaXMucmVuZGVyZXIuc2V0UHJvcGVydHkodGhpcy5lbC5uYXRpdmVFbGVtZW50LCAnc2Nyb2xsVG9wJywgcG9zaXRpb24pO1xyXG4gICAgdGhpcy5zdGF0ZS5zY3JvbGxTdHJlYW1BY3RpdmUgPSB0cnVlO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIG9uU2Nyb2xsYmFySGVpZ2h0Q2hhbmdlZCgpOiB2b2lkIHtcclxuICAgIHRoaXMuc2Nyb2xsSGVpZ2h0Q2hhbmdlZC5uZXh0KCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHJlZ2lzdGVyU2Nyb2xsRXZlbnRIYW5kbGVyKCk6IHZvaWQge1xyXG4gICAgdGhpcy5zY3JvbGxDaGFuZ2VkID0gZnJvbUV2ZW50KHRoaXMuZWwubmF0aXZlRWxlbWVudCwgJ3Njcm9sbCcpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSByZWdpc3Rlck11dGF0aW9uT2JzZXJ2ZXIoKTogdm9pZCB7XHJcbiAgICB0aGlzLmRvbU11dGF0aW9uT2JzZXJ2ZXIgPSBuZXcgTXV0YXRpb25PYnNlcnZlcihcclxuICAgICAgKG11dGF0aW9uczogTXV0YXRpb25SZWNvcmRbXSkgPT4ge1xyXG4gICAgICAgIHRoaXMuZG9tTXV0YXRpb25FbWl0dGVyLm5leHQobXV0YXRpb25zKTtcclxuICAgICAgfSk7XHJcblxyXG4gICAgY29uc3QgY29uZmlnID0geyBhdHRyaWJ1dGVzOiB0cnVlLCBjaGlsZExpc3Q6IHRydWUsIGNoYXJhY3RlckRhdGE6IHRydWUgfTtcclxuICAgIHRoaXMuZG9tTXV0YXRpb25PYnNlcnZlci5vYnNlcnZlKHRoaXMuZWwubmF0aXZlRWxlbWVudCwgY29uZmlnKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgcmVnaXN0ZXJJbml0aWFsU2Nyb2xsUG9zdGlvbkhhbmRsZXIoKTogdm9pZCB7XHJcbiAgICB0aGlzLmRvbU11dGF0aW9uRW1pdHRlci5waXBlKFxyXG4gICAgICB0YWtlV2hpbGUoKCkgPT4gdGhpcy5zdGF0ZS5pbml0TW9kZSksXHJcbiAgICAgIGRlYm91bmNlVGltZSh0aGlzLnNjcm9sbERlYm91bmNlVGltZUFmdGVyRE9NTXV0YXRpb25PbkluaXQpXHJcbiAgICApLnN1YnNjcmliZSgoKSA9PiB7XHJcbiAgICAgIHRoaXMuc2Nyb2xsaW5nU3RyYXRlZ3kuc2V0SW5pdGlhbFNjcm9sbFBvc2l0aW9uKCk7XHJcbiAgICAgIHRoaXMuc3RhdGUuaW5pdE1vZGUgPSBmYWxzZTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSByZWdpc3RlclByZXZpb3VzU2Nyb2xsUG9zaXRpb25IYW5kbGVyKCk6IHZvaWQge1xyXG4gICAgemlwKFxyXG4gICAgICB0aGlzLnNjcm9sbFJlcXVlc3Rab25lQ2hhbmdlZCxcclxuICAgICAgdGhpcy5zY3JvbGxIZWlnaHRDaGFuZ2VkXHJcbiAgICApLnBpcGUoXHJcbiAgICAgIHNraXBXaGlsZSgoKSA9PiB0aGlzLnN0YXRlLmluaXRNb2RlKSxcclxuICAgICAgZGVib3VuY2VUaW1lKHRoaXMuc2Nyb2xsRGVib3VuY2VUaW1lQWZ0ZXJTY3JvbGxIZWlnaHRDaGFuZ2VkKVxyXG4gICAgKS5zdWJzY3JpYmUoKCkgPT4ge1xyXG4gICAgICB0aGlzLnNjcm9sbGluZ1N0cmF0ZWd5LnNldFByZXZpb3VzU2Nyb2xsUG9zaXRpb24oKTtcclxuICAgICAgdGhpcy5zdGF0ZS5wcmV2aW91c1Njcm9sbFBvc2l0aW9ucFVwZGF0ZWQgPSB0cnVlO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHJlZ2lzdGVyU2Nyb2xsU3B5KCk6IHZvaWQge1xyXG4gICAgdGhpcy5zY3JvbGxSZXF1ZXN0Wm9uZUNoYW5nZWQuc3Vic2NyaWJlKCgpID0+IHtcclxuICAgICAgdGhpcy5zY3JvbGxpbmdTdHJhdGVneS5hc2tGb3JVcGRhdGUoKTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSB1c2VTdHJhdGVneSgpOiB2b2lkIHtcclxuICAgIHN3aXRjaCAodGhpcy5zdHJhdGVneSkge1xyXG4gICAgICBjYXNlICdzY3JvbGxpbmdUb0JvdGgnOlxyXG4gICAgICAgIHRoaXMuc2Nyb2xsaW5nU3RyYXRlZ3kgPSBuZXcgU2Nyb2xsaW5nVG9Cb3RoKHRoaXMsIHRoaXMuc3RhdGUpO1xyXG4gICAgICAgIGJyZWFrO1xyXG4gICAgICBjYXNlICdzY3JvbGxpbmdUb1RvcCc6XHJcbiAgICAgICAgdGhpcy5zY3JvbGxpbmdTdHJhdGVneSA9IG5ldyBTY3JvbGxpbmdUb1RvcCh0aGlzLCB0aGlzLnN0YXRlKTtcclxuICAgICAgICBicmVhaztcclxuICAgICAgY2FzZSAnc2Nyb2xsaW5nVG9Cb3R0b20nOiBkZWZhdWx0OlxyXG4gICAgICAgIHRoaXMuc2Nyb2xsaW5nU3RyYXRlZ3kgPSBuZXcgU2Nyb2xsaW5nVG9Cb3R0b20odGhpcywgdGhpcy5zdGF0ZSk7XHJcbiAgICAgICAgYnJlYWs7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHVzZVNjcm9sbEhlaWdodExpc3RlbmVyKCk6IHZvaWQge1xyXG4gICAgdGhpcy5zY3JvbGxIZWlnaHRMaXN0ZW5lciA9IG5ldyBTY3JvbGxIZWlnaHRMaXN0ZW5lcih0aGlzLCB0aGlzLnN0YXRlKTtcclxuICB9XHJcbn1cclxuIl19