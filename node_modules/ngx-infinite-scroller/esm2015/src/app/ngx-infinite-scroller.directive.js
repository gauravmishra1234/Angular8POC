import * as tslib_1 from "tslib";
import { Directive, ElementRef, Input, Output, EventEmitter, Renderer2, } from '@angular/core';
import { Subject, zip, fromEvent } from 'rxjs';
import { tap, map, pairwise, takeWhile, skipWhile, debounceTime } from 'rxjs/operators';
import { DirectiveStateService } from './directive-state.service';
import { InitialScrollPosition } from './enum/initial-scroll-position-type.enum';
import { DirectiveContext } from './directive-context';
import { ScrollingToTop } from './scrolling-strategy/scrolling-to-top';
import { ScrollingToBottom } from './scrolling-strategy/scrolling-to-bottom';
import { ScrollingToBoth } from './scrolling-strategy/scrolling-to-both';
import { ScrollHeightListener } from './scroll-height-listener/scroll-height-listener';
let NgxInfiniteScrollerDirective = class NgxInfiniteScrollerDirective extends DirectiveContext {
    constructor(el, renderer, state) {
        super();
        this.el = el;
        this.renderer = renderer;
        this.state = state;
        this.strategy = 'scrollingToBottom';
        this.initialScrollPosition = InitialScrollPosition.DEFAULT;
        this.scrollbarAnimationInterval = 100;
        this.scrollDebounceTimeAfterScrollHeightChanged = 50;
        this.scrollDebounceTimeAfterDOMMutationOnInit = 1000;
        this.scrollUpPercentilePositionTrigger = 2;
        this.scrollDownPercentilePositionTrigger = 98;
        this.onScrollUp = new EventEmitter();
        this.onScrollDown = new EventEmitter();
        this.scrollHeightChanged = new Subject();
        this.domMutationEmitter = new Subject();
        this.state.setup({
            el: el,
            initMode: true,
            scrollStreamActive: true,
            previousScrollPositionpUpdated: false
        });
    }
    get scrollPairChanged() {
        if (this.scrollChanged) {
            return this.scrollChanged.pipe(takeWhile(() => this.state.scrollStreamActive), map((e) => {
                return {
                    scrollHeight: e.target.scrollHeight,
                    scrollTop: e.target.scrollTop,
                    clientHeight: e.target.clientHeight,
                };
            }), pairwise(), debounceTime(this.scrollbarAnimationInterval));
        }
    }
    get scrollDirectionChanged() {
        return this.scrollingStrategy.scrollDirectionChanged(this.scrollPairChanged);
    }
    get scrollRequestZoneChanged() {
        return this.scrollingStrategy.scrollRequestZoneChanged(this.scrollDirectionChanged).pipe(tap(() => {
            this.state.updatePreviousScrollTop();
            this.state.updatePreviousScrollHeight();
            this.state.previousScrollPositionpUpdated = false;
            this.scrollHeightListener.start();
        }));
    }
    ngOnInit() {
        this.useStrategy();
        this.useScrollHeightListener();
        this.registerScrollEventHandler();
        this.registerMutationObserver();
        this.registerInitialScrollPostionHandler();
        this.registerPreviousScrollPositionHandler();
    }
    ngAfterViewInit() {
        this.registerScrollSpy();
    }
    ngOnDestroy() {
        this.domMutationObserver.disconnect();
    }
    scrollTo(position) {
        this.state.scrollStreamActive = false;
        this.renderer.setProperty(this.el.nativeElement, 'scrollTop', position);
        this.state.scrollStreamActive = true;
    }
    onScrollbarHeightChanged() {
        this.scrollHeightChanged.next();
    }
    registerScrollEventHandler() {
        this.scrollChanged = fromEvent(this.el.nativeElement, 'scroll');
    }
    registerMutationObserver() {
        this.domMutationObserver = new MutationObserver((mutations) => {
            this.domMutationEmitter.next(mutations);
        });
        const config = { attributes: true, childList: true, characterData: true };
        this.domMutationObserver.observe(this.el.nativeElement, config);
    }
    registerInitialScrollPostionHandler() {
        this.domMutationEmitter.pipe(takeWhile(() => this.state.initMode), debounceTime(this.scrollDebounceTimeAfterDOMMutationOnInit)).subscribe(() => {
            this.scrollingStrategy.setInitialScrollPosition();
            this.state.initMode = false;
        });
    }
    registerPreviousScrollPositionHandler() {
        zip(this.scrollRequestZoneChanged, this.scrollHeightChanged).pipe(skipWhile(() => this.state.initMode), debounceTime(this.scrollDebounceTimeAfterScrollHeightChanged)).subscribe(() => {
            this.scrollingStrategy.setPreviousScrollPosition();
            this.state.previousScrollPositionpUpdated = true;
        });
    }
    registerScrollSpy() {
        this.scrollRequestZoneChanged.subscribe(() => {
            this.scrollingStrategy.askForUpdate();
        });
    }
    useStrategy() {
        switch (this.strategy) {
            case 'scrollingToBoth':
                this.scrollingStrategy = new ScrollingToBoth(this, this.state);
                break;
            case 'scrollingToTop':
                this.scrollingStrategy = new ScrollingToTop(this, this.state);
                break;
            case 'scrollingToBottom':
            default:
                this.scrollingStrategy = new ScrollingToBottom(this, this.state);
                break;
        }
    }
    useScrollHeightListener() {
        this.scrollHeightListener = new ScrollHeightListener(this, this.state);
    }
};
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", String)
], NgxInfiniteScrollerDirective.prototype, "strategy", void 0);
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", Object)
], NgxInfiniteScrollerDirective.prototype, "initialScrollPosition", void 0);
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", Object)
], NgxInfiniteScrollerDirective.prototype, "scrollbarAnimationInterval", void 0);
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", Object)
], NgxInfiniteScrollerDirective.prototype, "scrollDebounceTimeAfterScrollHeightChanged", void 0);
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", Object)
], NgxInfiniteScrollerDirective.prototype, "scrollDebounceTimeAfterDOMMutationOnInit", void 0);
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", Object)
], NgxInfiniteScrollerDirective.prototype, "scrollUpPercentilePositionTrigger", void 0);
tslib_1.__decorate([
    Input(),
    tslib_1.__metadata("design:type", Object)
], NgxInfiniteScrollerDirective.prototype, "scrollDownPercentilePositionTrigger", void 0);
tslib_1.__decorate([
    Output(),
    tslib_1.__metadata("design:type", EventEmitter)
], NgxInfiniteScrollerDirective.prototype, "onScrollUp", void 0);
tslib_1.__decorate([
    Output(),
    tslib_1.__metadata("design:type", EventEmitter)
], NgxInfiniteScrollerDirective.prototype, "onScrollDown", void 0);
NgxInfiniteScrollerDirective = tslib_1.__decorate([
    Directive({
        selector: '[ngxInfiniteScroller]'
    }),
    tslib_1.__metadata("design:paramtypes", [ElementRef,
        Renderer2,
        DirectiveStateService])
], NgxInfiniteScrollerDirective);
export { NgxInfiniteScrollerDirective };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LWluZmluaXRlLXNjcm9sbGVyLmRpcmVjdGl2ZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25neC1pbmZpbml0ZS1zY3JvbGxlci8iLCJzb3VyY2VzIjpbInNyYy9hcHAvbmd4LWluZmluaXRlLXNjcm9sbGVyLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUNMLFNBQVMsRUFJVCxVQUFVLEVBQ1YsS0FBSyxFQUNMLE1BQU0sRUFDTixZQUFZLEVBQ1osU0FBUyxHQUNWLE1BQU0sZUFBZSxDQUFDO0FBRXZCLE9BQU8sRUFBYyxPQUFPLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUUzRCxPQUFPLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxRQUFRLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxZQUFZLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUV4RixPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUdsRSxPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSwwQ0FBMEMsQ0FBQztBQUVqRixPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUN2RCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sdUNBQXVDLENBQUM7QUFDdkUsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sMENBQTBDLENBQUM7QUFDN0UsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHdDQUF3QyxDQUFDO0FBRXpFLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLGlEQUFpRCxDQUFDO0FBS3ZGLElBQWEsNEJBQTRCLEdBQXpDLE1BQWEsNEJBQ1gsU0FBUSxnQkFBZ0I7SUF3RXhCLFlBQ1UsRUFBYyxFQUNkLFFBQW1CLEVBQ25CLEtBQTRCO1FBRXBDLEtBQUssRUFBRSxDQUFDO1FBSkEsT0FBRSxHQUFGLEVBQUUsQ0FBWTtRQUNkLGFBQVEsR0FBUixRQUFRLENBQVc7UUFDbkIs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VDtJQUNILENBQUM7SUFFTyx1QkFBdUI7UUFDN0IsSUFBSSxDQUFDLG9CQUFvQixHQUFHLElBQUksb0JBQW9CLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUN6RSxDQUFDO0NBQ0YsQ0FBQTtBQTFLQztJQURDLEtBQUssRUFBRTs7OERBQ3NDO0FBRzlDO0lBREMsS0FBSyxFQUFFOzsyRUFDcUY7QUFHN0Y7SUFEQyxLQUFLLEVBQUU7O2dGQUNnQztBQUd4QztJQURDLEtBQUssRUFBRTs7Z0dBQytDO0FBR3ZEO0lBREMsS0FBSyxFQUFFOzs4RkFDK0M7QUFHdkQ7SUFEQyxLQUFLLEVBQUU7O3VGQUNxQztBQUc3QztJQURDLEtBQUssRUFBRTs7eUZBQ3dDO0FBR2hEO0lBREMsTUFBTSxFQUFFO3NDQUNVLFlBQVk7Z0VBQWtDO0FBR2pFO0lBREMsTUFBTSxFQUFFO3NDQUNZLFlBQVk7a0VBQWtDO0FBN0J4RCw0QkFBNEI7SUFIeEMsU0FBUyxDQUFDO1FBQ1QsUUFBUSxFQUFFLHVCQUF1QjtLQUNsQyxDQUFDOzZDQTJFYyxVQUFVO1FBQ0osU0FBUztRQUNaLHFCQUFxQjtHQTVFM0IsNEJBQTRCLENBK0t4QztTQS9LWSw0QkFBNEIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xyXG4gIERpcmVjdGl2ZSxcclxuICBPbkRlc3Ryb3ksXHJcbiAgT25Jbml0LFxyXG4gIEFmdGVyVmlld0luaXQsXHJcbiAgRWxlbWVudFJlZixcclxuICBJbnB1dCxcclxuICBPdXRwdXQsXHJcbiAgRXZlbnRFbWl0dGVyLFxyXG4gIFJlbmRlcmVyMixcclxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuXHJcbmltcG9ydCB7IE9ic2VydmFibGUsIFN1YmplY3QsIHppcCwgZnJvbUV2ZW50IH0gZnJvbSAncnhqcyc7XHJcblxyXG5pbXBvcnQgeyB0YXAsIG1hcCwgcGFpcndpc2UsIHRha2VXaGlsZSwgc2tpcFdoaWxlLCBkZWJvdW5jZVRpbWUgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcblxyXG5pbXBvcnQgeyBEaXJlY3RpdmVTdGF0ZVNlcnZpY2UgfSBmcm9tICcuL2RpcmVjdGl2ZS1zdGF0ZS5zZXJ2aWNlJztcclxuXHJcbmltcG9ydCB7IFNjcm9sbFBvc2l0aW9uIH0gZnJvbSAnLi9tb2RlbC9zY3JvbGwtcG9zaXRpb24ubW9kZWwnO1xyXG5pbXBvcnQgeyBJbml0aWFsU2Nyb2xsUG9zaXRpb24gfSBmcm9tICcuL2VudW0vaW5pdGlhbC1zY3JvbGwtcG9zaXRpb24tdHlwZS5lbnVtJztcclxuXHJcbmltcG9ydCB7IERpcmVjdGl2ZUNvbnRleHQgfSBmcm9tICcuL2RpcmVjdGl2ZS1jb250ZXh0JztcclxuaW1wb3J0IHsgU2Nyb2xsaW5nVG9Ub3AgfSBmcm9tICcuL3Njcm9sbGluZy1zdHJhdGVneS9zY3JvbGxpbmctdG8tdG9wJztcclxuaW1wb3J0IHsgU2Nyb2xsaW5nVG9Cb3R0b20gfSBmcm9tICcuL3Njcm9sbGluZy1zdHJhdGVneS9zY3JvbGxpbmctdG8tYm90dG9tJztcclxuaW1wb3J0IHsgU2Nyb2xsaW5nVG9Cb3RoIH0gZnJvbSAnLi9zY3JvbGxpbmctc3RyYXRlZ3kvc2Nyb2xsaW5nLXRvLWJvdGgnO1xyXG5cclxuaW1wb3J0IHsgU2Nyb2xsSGVpZ2h0TGlzdGVuZXIgfSBmcm9tICcuL3Njcm9sbC1oZWlnaHQtbGlzdGVuZXIvc2Nyb2xsLWhlaWdodC1saXN0ZW5lcic7XHJcblxyXG5ARGlyZWN0aXZlKHtcclxuICBzZWxlY3RvcjogJ1tuZ3hJbmZpbml0ZVNjcm9sbGVyXSdcclxufSlcclxuZXhwb3J0IGNsYXNzIE5neEluZmluaXRlU2Nyb2xsZXJEaXJlY3RpdmVcclxuICBleHRlbmRzIERpcmVjdGl2ZUNvbnRleHRcclxuICBpbXBsZW1lbnRzIE9uSW5pdCwgQWZ0ZXJWaWV3SW5pdCwgT25EZXN0cm95IHtcclxuXHJcbiAgQElucHV0KClcclxuICBwdWJsaWMgc3RyYXRlZ3k6IHN0cmluZyA9ICdzY3JvbGxpbmdUb0JvdHRvbSc7XHJcblxyXG4gIEBJbnB1dCgpXHJcbiAgcHVibGljIGluaXRpYWxTY3JvbGxQb3NpdGlvbjogSW5pdGlhbFNjcm9sbFBvc2l0aW9uIHwgbnVtYmVyID0gSW5pdGlhbFNjcm9sbFBvc2l0aW9uLkRFRkFVTFQ7XHJcblxyXG4gIEBJbnB1dCgpXHJcbiAgcHVibGljIHNjcm9sbGJhckFuaW1hdGlvbkludGVydmFsID0gMTAwO1xyXG5cclxuICBASW5wdXQoKVxyXG4gIHB1YmxpYyBzY3JvbGxEZWJvdW5jZVRpbWVBZnRlclNjcm9sbEhlaWdodENoYW5nZWQgPSA1MDtcclxuXHJcbiAgQElucHV0KClcclxuICBwdWJsaWMgc2Nyb2xsRGVib3VuY2VUaW1lQWZ0ZXJET01NdXRhdGlvbk9uSW5pdCA9IDEwMDA7XHJcblxyXG4gIEBJbnB1dCgpXHJcbiAgcHVibGljIHNjcm9sbFVwUGVyY2VudGlsZVBvc2l0aW9uVHJpZ2dlciA9IDI7XHJcblxyXG4gIEBJbnB1dCgpXHJcbiAgcHVibGljIHNjcm9sbERvd25QZXJjZW50aWxlUG9zaXRpb25UcmlnZ2VyID0gOTg7XHJcblxyXG4gIEBPdXRwdXQoKVxyXG4gIHB1YmxpYyBvblNjcm9sbFVwOiBFdmVudEVtaXR0ZXI8bnVsbD4gPSBuZXcgRXZlbnRFbWl0dGVyPG51bGw+KCk7XHJcblxyXG4gIEBPdXRwdXQoKVxyXG4gIHB1YmxpYyBvblNjcm9sbERvd246IEV2ZW50RW1pdHRlcjxudWxsPiA9IG5ldyBFdmVudEVtaXR0ZXI8bnVsbD4oKTtcclxuXHJcbiAgcHJpdmF0ZSBzY3JvbGxIZWlnaHRMaXN0ZW5lcjogU2Nyb2xsSGVpZ2h0TGlzdGVuZXI7XHJcblxyXG4gIHByaXZhdGUgc2Nyb2xsSGVpZ2h0Q2hhbmdlZDogU3ViamVjdDxudWxsPiA9IG5ldyBTdWJqZWN0PG51bGw+KCk7XHJcblxyXG4gIHByaXZhdGUgZG9tTXV0YXRpb25PYnNlcnZlcjogTXV0YXRpb25PYnNlcnZlcjtcclxuXHJcbiAgcHJpdmF0ZSBkb21NdXRhdGlvbkVtaXR0ZXI6IFN1YmplY3Q8TXV0YXRpb25SZWNvcmRbXT4gPSBuZXcgU3ViamVjdDxNdXRhdGlvblJlY29yZFtdPigpO1xyXG5cclxuICBwcml2YXRlIHNjcm9sbENoYW5nZWQ6IE9ic2VydmFibGU8RXZlbnQ+O1xyXG5cclxuICBwcml2YXRlIGdldCBzY3JvbGxQYWlyQ2hhbmdlZCgpOiBPYnNlcnZhYmxlPFNjcm9sbFBvc2l0aW9uW10+IHtcclxuICAgIGlmICh0aGlzLnNjcm9sbENoYW5nZWQpIHtcclxuICAgICAgcmV0dXJuIHRoaXMuc2Nyb2xsQ2hhbmdlZC5waXBlKFxyXG4gICAgICAgIHRha2VXaGlsZSgoKSA9PiB0aGlzLnN0YXRlLnNjcm9sbFN0cmVhbUFjdGl2ZSksXHJcbiAgICAgICAgbWFwKChlOiBhbnkpID0+IHtcclxuICAgICAgICAgIHJldHVybiA8U2Nyb2xsUG9zaXRpb24+e1xyXG4gICAgICAgICAgICBzY3JvbGxIZWlnaHQ6IGUudGFyZ2V0LnNjcm9sbEhlaWdodCxcclxuICAgICAgICAgICAgc2Nyb2xsVG9wOiBlLnRhcmdldC5zY3JvbGxUb3AsXHJcbiAgICAgICAgICAgIGNsaWVudEhlaWdodDogZS50YXJnZXQuY2xpZW50SGVpZ2h0LFxyXG4gICAgICAgICAgfTtcclxuICAgICAgICB9KSxcclxuICAgICAgICBwYWlyd2lzZSgpLFxyXG4gICAgICAgIGRlYm91bmNlVGltZSh0aGlzLnNjcm9sbGJhckFuaW1hdGlvbkludGVydmFsKVxyXG4gICAgICApO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBnZXQgc2Nyb2xsRGlyZWN0aW9uQ2hhbmdlZCgpOiBPYnNlcnZhYmxlPFNjcm9sbFBvc2l0aW9uW10+IHtcclxuICAgIHJldHVybiB0aGlzLnNjcm9sbGluZ1N0cmF0ZWd5LnNjcm9sbERpcmVjdGlvbkNoYW5nZWQodGhpcy5zY3JvbGxQYWlyQ2hhbmdlZCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGdldCBzY3JvbGxSZXF1ZXN0Wm9uZUNoYW5nZWQoKTogT2JzZXJ2YWJsZTxTY3JvbGxQb3NpdGlvbltdPiB7XHJcbiAgICByZXR1cm4gdGhpcy5zY3JvbGxpbmdTdHJhdGVneS5zY3JvbGxSZXF1ZXN0Wm9uZUNoYW5nZWQodGhpcy5zY3JvbGxEaXJlY3Rpb25DaGFuZ2VkKS5waXBlKFxyXG4gICAgICB0YXAoKCkgPT4ge1xyXG4gICAgICAgIHRoaXMuc3RhdGUudXBkYXRlUHJldmlvdXNTY3JvbGxUb3AoKTtcclxuICAgICAgICB0aGlzLnN0YXRlLnVwZGF0ZVByZXZpb3VzU2Nyb2xsSGVpZ2h0KCk7XHJcbiAgICAgICAgdGhpcy5zdGF0ZS5wcmV2aW91c1Njcm9sbFBvc2l0aW9ucFVwZGF0ZWQgPSBmYWxzZTtcclxuICAgICAgICB0aGlzLnNjcm9sbEhlaWdodExpc3RlbmVyLnN0YXJ0KCk7XHJcbiAgICAgIH0pXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBwcml2YXRlIGVsOiBFbGVtZW50UmVmLFxyXG4gICAgcHJpdmF0ZSByZW5kZXJlcjogUmVuZGVyZXIyLFxyXG4gICAgcHJpdmF0ZSBzdGF0ZTogRGlyZWN0aXZlU3RhdGVTZXJ2aWNlXHJcbiAgKSB7XHJcbiAgICBzdXBlcigpO1xyXG4gICAgdGhpcy5zdGF0ZS5zZXR1cCh7XHJcbiAgICAgIGVsOiBlbCxcclxuICAgICAgaW5pdE1vZGU6IHRydWUsXHJcbiAgICAgIHNjcm9sbFN0cmVhbUFjdGl2ZTogdHJ1ZSxcclxuICAgICAgcHJldmlvdXNTY3JvbGxQb3NpdGlvbnBVcGRhdGVkOiBmYWxzZVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgbmdPbkluaXQoKTogdm9pZCB7XHJcbiAgICB0aGlzLnVzZVN0cmF0ZWd5KCk7XHJcbiAgICB0aGlzLnVzZVNjcm9sbEhlaWdodExpc3RlbmVyKCk7XHJcblxyXG4gICAgdGhpcy5yZWdpc3RlclNjcm9sbEV2ZW50SGFuZGxlcigpO1xyXG4gICAgdGhpcy5yZWdpc3Rlck11dGF0aW9uT2JzZXJ2ZXIoKTtcclxuICAgIHRoaXMucmVnaXN0ZXJJbml0aWFsU2Nyb2xsUG9zdGlvbkhhbmRsZXIoKTtcclxuICAgIHRoaXMucmVnaXN0ZXJQcmV2aW91c1Njcm9sbFBvc2l0aW9uSGFuZGxlcigpO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIG5nQWZ0ZXJWaWV3SW5pdCgpOiB2b2lkIHtcclxuICAgIHRoaXMucmVnaXN0ZXJTY3JvbGxTcHkoKTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBuZ09uRGVzdHJveSgpOiB2b2lkIHtcclxuICAgIHRoaXMuZG9tTXV0YXRpb25PYnNlcnZlci5kaXNjb25uZWN0KCk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgc2Nyb2xsVG8ocG9zaXRpb246IG51bWJlcik6IHZvaWQge1xyXG4gICAgdGhpcy5zdGF0ZS5zY3JvbGxTdHJlYW1BY3RpdmUgPSBmYWxzZTtcclxuICAgIHRoaXMucmVuZGVyZXIuc2V0UHJvcGVydHkodGhpcy5lbC5uYXRpdmVFbGVtZW50LCAnc2Nyb2xsVG9wJywgcG9zaXRpb24pO1xyXG4gICAgdGhpcy5zdGF0ZS5zY3JvbGxTdHJlYW1BY3RpdmUgPSB0cnVlO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIG9uU2Nyb2xsYmFySGVpZ2h0Q2hhbmdlZCgpOiB2b2lkIHtcclxuICAgIHRoaXMuc2Nyb2xsSGVpZ2h0Q2hhbmdlZC5uZXh0KCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHJlZ2lzdGVyU2Nyb2xsRXZlbnRIYW5kbGVyKCk6IHZvaWQge1xyXG4gICAgdGhpcy5zY3JvbGxDaGFuZ2VkID0gZnJvbUV2ZW50KHRoaXMuZWwubmF0aXZlRWxlbWVudCwgJ3Njcm9sbCcpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSByZWdpc3Rlck11dGF0aW9uT2JzZXJ2ZXIoKTogdm9pZCB7XHJcbiAgICB0aGlzLmRvbU11dGF0aW9uT2JzZXJ2ZXIgPSBuZXcgTXV0YXRpb25PYnNlcnZlcihcclxuICAgICAgKG11dGF0aW9uczogTXV0YXRpb25SZWNvcmRbXSkgPT4ge1xyXG4gICAgICAgIHRoaXMuZG9tTXV0YXRpb25FbWl0dGVyLm5leHQobXV0YXRpb25zKTtcclxuICAgICAgfSk7XHJcblxyXG4gICAgY29uc3QgY29uZmlnID0geyBhdHRyaWJ1dGVzOiB0cnVlLCBjaGlsZExpc3Q6IHRydWUsIGNoYXJhY3RlckRhdGE6IHRydWUgfTtcclxuICAgIHRoaXMuZG9tTXV0YXRpb25PYnNlcnZlci5vYnNlcnZlKHRoaXMuZWwubmF0aXZlRWxlbWVudCwgY29uZmlnKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgcmVnaXN0ZXJJbml0aWFsU2Nyb2xsUG9zdGlvbkhhbmRsZXIoKTogdm9pZCB7XHJcbiAgICB0aGlzLmRvbU11dGF0aW9uRW1pdHRlci5waXBlKFxyXG4gICAgICB0YWtlV2hpbGUoKCkgPT4gdGhpcy5zdGF0ZS5pbml0TW9kZSksXHJcbiAgICAgIGRlYm91bmNlVGltZSh0aGlzLnNjcm9sbERlYm91bmNlVGltZUFmdGVyRE9NTXV0YXRpb25PbkluaXQpXHJcbiAgICApLnN1YnNjcmliZSgoKSA9PiB7XHJcbiAgICAgIHRoaXMuc2Nyb2xsaW5nU3RyYXRlZ3kuc2V0SW5pdGlhbFNjcm9sbFBvc2l0aW9uKCk7XHJcbiAgICAgIHRoaXMuc3RhdGUuaW5pdE1vZGUgPSBmYWxzZTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSByZWdpc3RlclByZXZpb3VzU2Nyb2xsUG9zaXRpb25IYW5kbGVyKCk6IHZvaWQge1xyXG4gICAgemlwKFxyXG4gICAgICB0aGlzLnNjcm9sbFJlcXVlc3Rab25lQ2hhbmdlZCxcclxuICAgICAgdGhpcy5zY3JvbGxIZWlnaHRDaGFuZ2VkXHJcbiAgICApLnBpcGUoXHJcbiAgICAgIHNraXBXaGlsZSgoKSA9PiB0aGlzLnN0YXRlLmluaXRNb2RlKSxcclxuICAgICAgZGVib3VuY2VUaW1lKHRoaXMuc2Nyb2xsRGVib3VuY2VUaW1lQWZ0ZXJTY3JvbGxIZWlnaHRDaGFuZ2VkKVxyXG4gICAgKS5zdWJzY3JpYmUoKCkgPT4ge1xyXG4gICAgICB0aGlzLnNjcm9sbGluZ1N0cmF0ZWd5LnNldFByZXZpb3VzU2Nyb2xsUG9zaXRpb24oKTtcclxuICAgICAgdGhpcy5zdGF0ZS5wcmV2aW91c1Njcm9sbFBvc2l0aW9ucFVwZGF0ZWQgPSB0cnVlO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHJlZ2lzdGVyU2Nyb2xsU3B5KCk6IHZvaWQge1xyXG4gICAgdGhpcy5zY3JvbGxSZXF1ZXN0Wm9uZUNoYW5nZWQuc3Vic2NyaWJlKCgpID0+IHtcclxuICAgICAgdGhpcy5zY3JvbGxpbmdTdHJhdGVneS5hc2tGb3JVcGRhdGUoKTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSB1c2VTdHJhdGVneSgpOiB2b2lkIHtcclxuICAgIHN3aXRjaCAodGhpcy5zdHJhdGVneSkge1xyXG4gICAgICBjYXNlICdzY3JvbGxpbmdUb0JvdGgnOlxyXG4gICAgICAgIHRoaXMuc2Nyb2xsaW5nU3RyYXRlZ3kgPSBuZXcgU2Nyb2xsaW5nVG9Cb3RoKHRoaXMsIHRoaXMuc3RhdGUpO1xyXG4gICAgICAgIGJyZWFrO1xyXG4gICAgICBjYXNlICdzY3JvbGxpbmdUb1RvcCc6XHJcbiAgICAgICAgdGhpcy5zY3JvbGxpbmdTdHJhdGVneSA9IG5ldyBTY3JvbGxpbmdUb1RvcCh0aGlzLCB0aGlzLnN0YXRlKTtcclxuICAgICAgICBicmVhaztcclxuICAgICAgY2FzZSAnc2Nyb2xsaW5nVG9Cb3R0b20nOiBkZWZhdWx0OlxyXG4gICAgICAgIHRoaXMuc2Nyb2xsaW5nU3RyYXRlZ3kgPSBuZXcgU2Nyb2xsaW5nVG9Cb3R0b20odGhpcywgdGhpcy5zdGF0ZSk7XHJcbiAgICAgICAgYnJlYWs7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHVzZVNjcm9sbEhlaWdodExpc3RlbmVyKCk6IHZvaWQge1xyXG4gICAgdGhpcy5zY3JvbGxIZWlnaHRMaXN0ZW5lciA9IG5ldyBTY3JvbGxIZWlnaHRMaXN0ZW5lcih0aGlzLCB0aGlzLnN0YXRlKTtcclxuICB9XHJcbn1cclxuIl19